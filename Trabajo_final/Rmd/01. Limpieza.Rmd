---
title: "Limpieza"
author: "Esteban Navarro"
date: "2025-12-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Librerías

```{r}
#install.packages("googlesheets4")
#install.packages("tidyverse")
#install.packages("cluster")
#install.packages("fastDummies")
#install.packages("FactoMineR")
#install.packages("factoextra")
#install.packages("caret")
#install.packages("reticulate")
#install.packages("psych")
#install.packages("ggcorrplot")
#install.packages("janitor")
#install.packages("summarytools")
#install.packages("cowplot")
#install.packages("downloader")
```

```{r, warnings=FALSE, message=FALSE}
library(googlesheets4)
library(tidyverse)
library(fastDummies)
library(FactoMineR)
library(factoextra)
library(cluster)
library(dendextend)
library(caret)
library(reticulate)
library(htmltools)
library(IRdisplay)
```

```{r, warnings=FALSE, message=FALSE}
library(tidyverse)
library(fastDummies)
library(FactoMineR)
library(factoextra)
library(cluster)
library(dendextend)
library(caret)
library(reticulate)
library(htmltools)
library(IRdisplay)
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
library(psych)
library(ggcorrplot)
library(janitor)
library(summarytools)
library(broom)

library(tidyverse)
source("../funciones/leer_df_final.R")
library(lsr)
```

## Carga de datos

```{r}
datos_crudos <- read.csv("../data/datos_crudos.csv", stringsAsFactors = FALSE)
```


```{r}
# =========================================================
# 2) LIMPIEZA DE NOMBRES (snake_case) + ARREGLOS PUNTUALES
# =========================================================
datos_crudos <- datos_crudos %>%
  janitor::clean_names() %>%
  # Arregla casos típicos de Forms: "marca_temporal" etc.
  rename(
    marca_temporal = any_of(c("marca_temporal", "marca_temporal_1", "marca_temporal_2"))
  )

# (Opcional) ver nombres ya limpios
# names(datos_crudos)

# =========================================================
# 3) RENOMBRAR A TUS NOMBRES "FINALES"
#    Nota: aquí uso any_of() para que NO se rompa si alguna
#    columna no existe exactamente con ese nombre limpio.
#    Si alguna no se renombra, revisá names(datos_crudos).
# =========================================================
df <- datos_crudos %>%
  rename(
    # -------------------------------
    # Sección 1
    # -------------------------------
    fecha = any_of(c("marca_temporal")),

    salud_fisica         = any_of(c("x1_mi_salud_fisica_afecta_mi_estado_de_animo")),
    maltrato_emocional   = any_of(c("x2_durante_la_ninez_y_adolescencia_vivi_experiencias_en_las_que_fui_maltratado_o_humillado_emocionalmente")),
    castigo_fisico       = any_of(c("x3_durante_la_ninez_y_adolescencia_recibi_castigos_fisicos_o_golpes_que_me_causaron_dano_o_miedo")),
    abuso_sexual         = any_of(c("x4_durante_la_ninez_y_adolescencia_fui_victima_de_contacto_sexual_forzado_o_inapropiado_por_parte_de_alguien_mayor")),
    ocultar_emociones    = any_of(c("x5_siento_que_debo_ocultar_mis_emociones_para_no_parecer_debil")),
    dificultad_pedir_ayuda = any_of(c("x6_me_cuesta_pedir_ayuda_cuando_enfrento_una_dificultad")),
    guarda_sentimientos  = any_of(c("x7_cuando_estoy_triste_o_dolido_prefiero_guardarmelo_para_mi")),

    # -------------------------------
    # Sección 2 (últimos 7 días)
    # -------------------------------
    sin_motivacion = any_of(c("x1_cuantas_veces_en_los_ultimos_7_dias_me_he_sentido_sin_motivacion_para_realizar_mis_actividades")),
    preocupado     = any_of(c("x2_cuantas_veces_en_los_ultimos_7_dias_me_he_sentido_preocupado")),
    sin_proposito  = any_of(c("x3_cuantas_veces_en_los_ultimos_7_dias_he_sentido_que_la_vida_ha_perdido_su_sentido_y_proposito")),
    no_reconocer_logros = any_of(c("x4_cuantas_veces_en_los_ultimos_7_dias_me_ha_costado_reconocer_mis_logros_y_aspectos_positivos")),
    incapaz_solucionar  = any_of(c("x5_cuantas_veces_en_los_ultimos_7_dias_he_pensado_que_soy_incapaz_de_encontrar_una_solucion_a_mis_problemas")),
    intento_autolesion  = any_of(c("x6_cuantas_veces_en_los_ultimos_7_dias_he_intentado_hacerme_dano")),
    plan_autolesion     = any_of(c("x7_cuantas_veces_en_los_ultimos_7_dias_he_hecho_planes_para_hacerme_dano")),
    autolesion_fisica   = any_of(c("x8_cuantas_veces_en_los_ultimos_7_dias_me_he_hecho_dano_fisico_de_manera_intencional_por_ejemplo_cortarme_golpearme_o_provocarme_dolor")),
    conduccion_temeraria = any_of(c("x9_cuantas_veces_en_los_ultimos_7_dias_he_conducido_de_manera_arriesgada_o_sin_cuidado_por_mi_seguridad")),
    soledad             = any_of(c("x10_cuantas_veces_en_los_ultimos_7_dias_me_he_sentido_solo_o_sin_apoyo")),
    conflicto_familiar  = any_of(c("x11_cuantas_veces_en_los_ultimos_7_dias_he_tenido_conflictos_o_discusiones_en_mi_familia")),
    dificultad_economica = any_of(c("x12_cuantas_veces_en_los_ultimos_7_dias_he_tenido_dificultades_economicas_que_me_preocupan")),
    exigencia_academica_laboral = any_of(c("x13_cuantas_veces_en_los_ultimos_7_dias_tuve_muchas_exigencias_academicas_o_laborales")),
    descontrol_drogas   = any_of(c("x14_cuantas_veces_en_los_ultimos_7_dias_he_sentido_que_pierdo_el_control_al_consumir_algunas_drogas")),
    abuso_alcohol       = any_of(c("x15_cuantas_veces_en_los_ultimos_7_dias_he_abusado_del_consumo_de_bebidas_alcoholicas",
                                   "x15_he_abusado_del_consumo_de_bebidas_alcoholicas")),
    descontrol_enojo    = any_of(c("x16_cuantas_veces_en_los_ultimos_7_dias_cuando_me_enojo_o_me_altero_siento_que_pierdo_el_control_de_mis_reacciones")),

    # -------------------------------
    # Sección 3 (Sí/No)
    # -------------------------------
    medicamento_psiquiatrico = any_of(c("x1_alguna_vez_en_mi_vida_he_tomado_medicamentos_psiquiatricos_ansioliticos_antidepresivos_etc")),
    discapacidad_fisica      = any_of(c("x2_tengo_alguna_discapacidad_fisica_por_ejemplo_perdida_de_audicion_o_amputacion")),
    suicidio_familiar        = any_of(c("x3_alguna_persona_de_mi_familia_ha_intentado_quitarse_la_vida_o_se_ha_suicidado")),
    ruptura_reciente         = any_of(c("x4_en_el_ultimo_mes_he_pasado_por_una_ruptura_o_separacion_de_pareja_que_me_ha_impactado_emocionalmente")),
    crisis_pareja_actual     = any_of(c("x5_actualmente_estoy_pasando_por_una_crisis_en_mi_relacion_de_pareja")),
    medidas_cautelares       = any_of(c("x6_tengo_vigentes_medidas_cautelares_por_violencia_domestica_u_otras_razones_legales")),

    # -------------------------------
    # Sección 4 (Roberts)
    # -------------------------------
    roberts_pensado_muerte   = any_of(c("x1_pense_en_la_muerte")),
    roberts_mejor_sin_mi     = any_of(c("x2_mi_familia_y_mis_amigos_estarian_mejor_si_yo_estuviera_muerto")),
    roberts_pensado_matarme  = any_of(c("x3_pense_en_matarme")),
    roberts_plan_suicida     = any_of(c("x4_me_mataria_si_encontrara_o_tuviera_la_manera_de_hacerlo")),

    # -------------------------------
    # Sección 5 (Demografía)
    # -------------------------------
    edad = any_of(c("x1_edad_numero_de_anos_cumplidos")),
    escolaridad = any_of(c("x2_grado_de_escolaridad")),
    estado_civil = any_of(c("x3_estado_civil")),
    ocupacion = any_of(c("x4_ocupacion")),
    orientacion_sexual = any_of(c("x5_orientacion_sexual")),
    provincia = any_of(c("x6_provincia_donde_vive")),
    canton = any_of(c("x7_canton_donde_vive")),
    grupo_wem = any_of(c("grupo_al_que_asiste_de_wem", "grupo_al_que_asiste_de_wem_1", "grupo_al_que_asiste_de_wem_2")),
    sesiones_cumplidas = any_of(c("cantidad_de_sesiones_cumplidas_en_numero")),
    dia = any_of(c("dia_de_la_semana_al_que_mas_asiste_al_grupo"))
  )

```


```{r}
# 1. Definimos las categorías exactas que aparecen en la imagen
categorias_validas <- c(
  "Estudiante",
  "Trabajador asalariado",
  "Trabajador independiente",
  "Desempleado",
  "Pensionado / Jubilado"
)

# 2. Aplicamos la limpieza
df <- df %>%
  mutate(ocupacion = fct_other(
    ocupacion,
    keep = categorias_validas,  # Mantiene solo estas
    other_level = "Otro"        # Todo lo demás se etiqueta como "Otro"
  ))

# Verificamos el resultado
table(df$ocupacion)
```

```{r}
glimpse(df)
```

## Recodificación

```{r}
# 1. Definir los grupos de variables para cada tipo de recodificación
vars_freq <- c(
  'salud_fisica', 'maltrato_emocional', 'castigo_fisico', 'abuso_sexual',
  'ocultar_emociones', 'dificultad_pedir_ayuda', 'guarda_sentimientos'
)

vars_dias <- c(
  'sin_motivacion', 'preocupado', 'sin_proposito', 'no_reconocer_logros',
  'incapaz_solucionar', 'intento_autolesion', 'plan_autolesion', 'autolesion_fisica',
  'conduccion_temeraria', 'soledad', 'conflicto_familiar', 'dificultad_economica',
  'exigencia_academica_laboral', 'descontrol_drogas', 'abuso_alcohol', 'descontrol_enojo'
)

vars_roberts <- c(
  'roberts_pensado_muerte', 'roberts_mejor_sin_mi',
  'roberts_pensado_matarme', 'roberts_plan_suicida'
)

# 2. Aplicar la recodificación usando mutate() y across()
df <- df %>%
  mutate(
    # Recodificación para la Sección 2 (Escala de Frecuencia General)
    across(all_of(vars_freq), ~case_when(
      . == "Nunca"         ~ 0,
      . == "Casi nunca"    ~ 1,
      . == "Rara vez"      ~ 2,
      . == "A veces"       ~ 3,
      . == "Con frecuencia"~ 4,
      . == "Casi siempre"  ~ 5,
      . == "Siempre"       ~ 6,
      TRUE                ~ NA_real_ # Por si hay algún valor inesperado
    )),

    # Recodificación para la Sección 3 (Frecuencia en los últimos 7 días)
    across(all_of(vars_dias), ~case_when(
      . == "Nunca"         ~ 0,
      . == "1 - 2 días"    ~ 1,
      . == "3 días"        ~ 2,
      . == "4 días"        ~ 3,
      . == "5 días"        ~ 4,
      . == "6 días"        ~ 5,
      . == "Todos los días"~ 6,
      TRUE                ~ NA_real_
    )),

    # Recodificación para la Sección 5 (Escala Roberts - Frecuencia en la última semana)
    across(all_of(vars_roberts), ~case_when(
      . == "0 días"       ~ 0,
      . == "1-2 días"      ~ 1,
      . == "3-4 días"      ~ 2,
      . == "5-7 días"      ~ 3,
      TRUE                ~ NA_real_
    ))
  )
```

```{r}
df <- df %>%
  mutate(
    EIS_Roberts = rowSums(select(., all_of(vars_roberts)), na.rm = TRUE)
  )
```

```{r}
df <- df %>%
  mutate(
    EIS_Cat = case_when(
      EIS_Roberts <= 5          ~ "Bajo",
      EIS_Roberts >= 6 & EIS_Roberts <= 8 ~ "Medio",
      EIS_Roberts >= 9          ~ "Alto",
      TRUE                      ~ NA_character_ # Manejo de casos inesperados (como NAs)
    )
  )
```

```{r}
glimpse(df)
```

## Formato de variables

```{r}
df <- df %>%
  mutate(across(where(is.character), as.factor))
```


```{r}
str(df)
```

```{r}
df_final <- df %>%
  select(EIS_Roberts,
         sesiones_cumplidas,edad, salud_fisica, maltrato_emocional, castigo_fisico,
         abuso_sexual, ocultar_emociones, dificultad_pedir_ayuda,
         guarda_sentimientos, sin_motivacion, preocupado, sin_proposito,
         no_reconocer_logros,incapaz_solucionar, intento_autolesion,
         plan_autolesion, autolesion_fisica, conduccion_temeraria, soledad,
         conflicto_familiar, dificultad_economica, exigencia_academica_laboral,
         descontrol_drogas, abuso_alcohol, descontrol_enojo,
         medicamento_psiquiatrico, discapacidad_fisica, suicidio_familiar,
         ruptura_reciente, crisis_pareja_actual, medidas_cautelares, 
         escolaridad, estado_civil, ocupacion)
```

```{r}
str(df_final)
```

## Datos escalados

```{r}
# 3. Identificar las columnas numéricas y factores en este nuevo conjunto
vars_numericas <- df_final %>%
  select(where(is.numeric)) %>%
  names()

vars_factores <- df_final %>%
  select(where(is.factor)) %>%
  names()

# 4. Crear variables dummy a partir de TODOS los factores (incluyendo EIS_Cat)
df_dummies <- dummy_cols(
  df_final,
  select_columns = vars_factores,
  remove_selected_columns = TRUE) # Elimina las columnas factor originales
```

```{r}
# 5. Aislar y escalar TODAS las variables numéricas (incluyendo EIS_Roberts)
datos_numericos <- df_final %>% select(all_of(vars_numericas))
datos_escalados <- as.data.frame(scale(datos_numericos))

# 6. Unir los datos numéricos escalados con las nuevas variables dummy
#    Primero, nos quedamos solo con las columnas dummy que se crearon
df_dummies_solo <- df_dummies %>% select(-all_of(vars_numericas))

#    Finalmente, los unimos
df_escalado <- bind_cols(datos_escalados, df_dummies_solo)
```

```{r}
df_escalado <- df_escalado %>%
  rename(
    # Escolaridad
    posgrado = `escolaridad_Posgrado (Maestría / Doctorado)`,
    prim_completa = `escolaridad_Primaria completa`,
    prim_incompleta = `escolaridad_Primaria incompleta`,
    sec_completa = `escolaridad_Secundaria completa`,
    sec_incompleta = `escolaridad_Secundaria incompleta`,
    tecnico = `escolaridad_Técnico medio / Diplomado`,
    u_completo = `escolaridad_Universitario completo`,
    u_incompleto = `escolaridad_Universitario incompleto`,

    # Estado Civil
    casado = `estado_civil_Casado`,
    divorciado = `estado_civil_Divorciado`,
    separado = `estado_civil_Separado`,
    soltero = `estado_civil_Soltero`,
    union_libre = `estado_civil_Unión libre`,

    # Ocupación
    desempleado = `ocupacion_Desempleado`,
    asalariado = `ocupacion_Trabajador asalariado`,
    independiente = `ocupacion_Trabajador independiente`)
```

```{r}
str(df_escalado)
```

# Guardar datos

```{r}
write.csv(df_final, "../data/df_final.csv", row.names = FALSE)
write.csv(df_escalado, "../data/df_escalado.csv", row.names = FALSE)
```

```{r}
saveRDS(df_final, "../data/df_final.rds")

```






